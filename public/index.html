<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saj√°t Messenger</title>
    <script src="/socket.io/socket.io.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
            authDomain: "sajatmesenger.firebaseapp.com",
            projectId: "sajatmesenger",
            storageBucket: "sajatmesenger.firebasestorage.app",
            messagingSenderId: "916403691764",
            appId: "1:916403691764:web:51fd4ec82de42c63917ea1",
            measurementId: "G-BYNSFK4FBL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        window.register = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const nev = document.getElementById('reg-name').value;
            if (!email || pass.length < 6 || !nev) return alert("Minden mez≈ët t√∂lts ki!");
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(userCredential.user, { displayName: nev });
                location.reload();
            } catch (err) { alert(err.message); }
        };

        window.login = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                document.getElementById('user-display-name').innerText = user.displayName || user.email;
                joinRoom('kozponti-szoba');
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('chat-screen').style.display = 'none';
            }
        });
    </script>

    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: #f0f2f5; }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { width: 90%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; }
        
        /* Chat */
        #chat-screen { display: none; height: 100vh; flex-direction: column; }
        .header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        #uzenetek { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .uzenet { padding: 10px 15px; border-radius: 18px; max-width: 70%; background: #e4e6eb; font-size: 15px; }
        .sajat { align-self: flex-end; background: #0084ff; color: white; }
        
        /* H√≠v√°s ablak (Messenger st√≠lus) */
        #call-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 2000; flex-direction: column; align-items: center; justify-content: center; color: white; 
        }
        .caller-img { width: 100px; height: 100px; background: #555; border-radius: 50%; margin-bottom: 20px; border: 3px solid #0084ff; }
        .call-buttons { display: flex; gap: 40px; margin-top: 50px; }
        .c-btn { width: 65px; height: 65px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .accept { background: #31a24c; }
        .decline { background: #fa3e3e; }
        
        .footer { padding: 10px; background: white; display: flex; gap: 10px; }
        .footer button { background: none; border: none; font-size: 20px; cursor: pointer; color: #0084ff; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:#0084ff">Messenger</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Jelsz√≥">
            <button onclick="login()" style="width:100%; background:#0084ff; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">Bejelentkez√©s</button>
            <p>vagy</p>
            <input type="text" id="reg-name" placeholder="Teljes n√©v">
            <button onclick="register()" style="width:100%; background:#31a24c; color:white; border:none; padding:12px; border-radius:8px;">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="call-overlay">
        <div class="caller-img"></div>
        <h2 id="caller-name">Bej√∂v≈ë h√≠v√°s...</h2>
        <div class="call-buttons">
            <button class="c-btn decline" onclick="endCall()">üìû</button>
            <button class="c-btn accept" onclick="acceptCall()">üìû</button>
        </div>
    </div>

    <div id="chat-screen">
        <div class="header">
            <b id="user-display-name">Bet√∂lt√©s...</b>
            <button onclick="startCall()" style="background:none; border:none; font-size:22px; cursor:pointer;">üìû</button>
        </div>
        <div id="uzenetek"></div>
        <div class="footer">
            <input type="text" id="szoveg" placeholder="Aa" style="border-radius:20px; background:#f0f2f5; border:none;">
            <button onclick="kuld()">‚û°Ô∏è</button>
        </div>
    </div>

    <audio id="tavoliHang" autoplay></audio>

    <script>
        const socket = io();
        let pc, localStream, room = 'kozponti-szoba';

        window.joinRoom = (id) => {
            room = id;
            socket.emit('join-room', id);
        };

        window.kuld = () => {
            const val = document.getElementById('szoveg').value;
            const nev = document.getElementById('user-display-name').innerText;
            if(val) {
                socket.emit('privat-uzenet', { roomId: room, nev: nev, szoveg: val });
                document.getElementById('szoveg').value = "";
            }
        };

        socket.on('uj-uzenet', (adat) => {
            const div = document.createElement('div');
            const isSajat = adat.nev === document.getElementById('user-display-name').innerText;
            div.className = 'uzenet ' + (isSajat ? 'sajat' : '');
            div.innerText = adat.szoveg;
            document.getElementById('uzenetek').appendChild(div);
            document.getElementById('uzenetek').scrollTop = document.getElementById('uzenetek').scrollHeight;
        });

        // H√çV√ÅS LOGIKA
        async function startCall() {
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('caller-name').innerText = "H√≠v√°s ind√≠t√°sa...";
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupPeer();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('hivas-ajanlat', { offer, nev: document.getElementById('user-display-name').innerText });
        }

        socket.on('hivas-ajanlat', async (adat) => {
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('caller-name').innerText = adat.nev + " h√≠v t√©ged...";
            // Itt t√°roljuk el az aj√°nlatot, hogy a felv√©teln√©l haszn√°lhassuk
            window.pendingOffer = adat.offer;
        });

        async function acceptCall() {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            setupPeer();
            await pc.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('hivas-valasz', answer);
            document.getElementById('caller-name').innerText = "Vonalban...";
        }

        socket.on('hivas-valasz', async (answer) => {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            document.getElementById('caller-name').innerText = "Vonalban...";
        });

        function setupPeer() {
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => document.getElementById('tavoliHang').srcObject = e.streams[0];
            pc.onicecandidate = e => e.candidate && socket.emit('ice-candidate', e.candidate);
        }

        socket.on('ice-candidate', c => pc && pc.addIceCandidate(new RTCIceCandidate(c)));

        function endCall() {
            location.reload();
        }
    </script>
</body>
</html>
