<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger</title>
    <style>
        /* A kor√°bbi st√≠lusok maradnak, plusz a h√≠v√°s fel√ºlete: */
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .profile-card { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; background: #eee; }
        
        #main-chat { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
        
        /* H√≠v√°s Ablak St√≠lusa */
        #call-overlay {
            position: absolute; inset: 0; background: #1c1e21; z-index: 500;
            display: none; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        #video-container { position: relative; width: 100%; height: 80%; display: flex; justify-content: center; background: black; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; height: 160px; position: absolute; bottom: 20px; right: 20px; border: 2px solid white; border-radius: 8px; background: #333; }
        
        .call-controls { display: flex; gap: 20px; padding: 20px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; }
        .hangup { background: #ff3b30; }
        .toggle-cam { background: #4e4e4e; }
        .toggle-mic { background: #4e4e4e; }

        .incoming-call-notif {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #0084ff; color: white; padding: 15px 25px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; display: none; gap: 15px; align-items: center;
        }

        /* √úzenet st√≠lusok (az el≈ëz≈ëek alapj√°n) */
        .msg { padding: 10px; border-radius: 18px; max-width: 75%; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; }
        .sent { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: white; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="incoming-notif" class="incoming-call-notif">
        <span id="caller-name">H√≠v√°s...</span>
        <button onclick="answerCall()" style="background:#42b72a; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer;">Felv√©tel</button>
        <button onclick="rejectCall()" style="background:#ff3b30; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer;">Elutas√≠t√°s</button>
    </div>

    <div id="call-overlay">
        <div id="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="call-controls">
            <button class="call-btn toggle-mic" onclick="toggleMic()" id="mic-btn">üéôÔ∏è</button>
            <button class="call-btn toggle-cam" onclick="toggleCam()" id="cam-btn">üìπ</button>
            <button class="call-btn hangup" onclick="endCall()">üìû</button>
        </div>
    </div>

    <div id="login-screen" class="active">... (Bejelentkez√©si ≈±rlap) ...</div>

    <div id="sidebar">
        <div class="profile-card">
            <label><img id="my-avatar" class="avatar" src=""><input type="file" id="p-upload" hidden accept="image/*"></label>
            <h3 id="my-name">...</h3>
            <button onclick="logout()">Kijelentkez√©s</button>
        </div>
        <div id="friend-list" class="item-list"></div>
    </div>

    <div id="main-chat">
        <div class="chat-header">
            <span id="chat-title">V√°lassz partnert</span>
            <div id="call-actions" style="display:none;">
                <button onclick="startCall(true)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìπ</button>
                <button onclick="startCall(false)" style="background:none; border:none; font-size:20px; cursor:pointer;">üìû</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="√úzenet...">
            <button onclick="sendMessage()">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    // Firebase importok (maradnak a r√©giek)
    // ... initializeApp, getFirestore, stb. ...

    let localStream;
    let remoteStream;
    let peerConnection;
    let currentCallDocId = null;

    const servers = {
        iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }]
    };

    // 1. H√çV√ÅS IND√çT√ÅSA
    window.startCall = async (withVideo) => {
        document.getElementById('call-overlay').style.display = 'flex';
        
        // M√©dia el√©r√©se
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: withVideo, 
            audio: true 
        });
        document.getElementById('local-video').srcObject = localStream;

        // WebRTC Peer be√°ll√≠t√°sa
        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Signaling Firebase-en kereszt√ºl (egyszer≈±s√≠tett logika)
        // Itt l√©trehozn√°nk egy "calls" kollekci√≥t √©s bele√≠rn√°nk az Offer-t
        alert("H√≠v√°s kezdem√©nyez√©se... (A WebRTC signaling szerver be√°ll√≠t√°st ig√©nyel)");
    };

    // 2. KAMERA / MIKROFON V√ÅLT√ÅSA H√çV√ÅS K√ñZBEN
    window.toggleCam = () => {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            document.getElementById('cam-btn').innerText = videoTrack.enabled ? "üìπ" : "üö´";
            document.getElementById('cam-btn').style.background = videoTrack.enabled ? "#4e4e4e" : "#ff3b30";
        } else {
            // Ha hangh√≠v√°sb√≥l indultunk, itt lehetne hozz√°adni a vide√≥t menet k√∂zben
            alert("Vide√≥ aktiv√°l√°sa...");
        }
    };

    window.toggleMic = () => {
        const audioTrack = localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        document.getElementById('mic-btn').innerText = audioTrack.enabled ? "üéôÔ∏è" : "üîá";
        document.getElementById('mic-btn').style.background = audioTrack.enabled ? "#4e4e4e" : "#ff3b30";
    };

    // 3. H√çV√ÅS Befejez√©se
    window.endCall = () => {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('call-overlay').style.display = 'none';
        if (peerConnection) peerConnection.close();
    };

    // --- A kor√°bbi Messenger √ºzenetkezel≈ë √©s profilk√©p szinkron k√≥dja itt folytat√≥dik ---
</script>
</body>
</html>
