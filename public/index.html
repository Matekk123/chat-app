<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger - Admin Pro</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .profile-card { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; }
        #chat-list { flex: 1; overflow-y: auto; }
        .item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
        .item:hover { background: #f9f9f9; }
        #main-chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #f0f2f5; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; background: #0084ff; color: white; cursor: pointer; }
        .received { align-self: flex-start; background: white; color: black; border: 1px solid #ddd; }
        .time { font-size: 10px; align-self: flex-end; opacity: 0.6; }
        .chat-header { padding: 15px; border-bottom: 1px solid #ddd; background: white; display: flex; justify-content: space-between; align-items: center; }
        .input-area { padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .btn { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 12px; color: white; }
        .blue { background: #0084ff; }
        .red { background: #e74c3c; }
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
        .group-tag { background: #e1e1e1; color: #555; font-size: 10px; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-screen" class="active">
        <div style="width: 280px; text-align: center;">
            <h2 style="color: #0084ff;">BalassaMessenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Jelsz√≥">
            <button onclick="login()" style="width: 100%; padding: 10px; background: #0084ff; color: white; border: none; border-radius: 5px; margin-top: 10px;">Bel√©p√©s</button>
            <hr>
            <input type="text" id="reg-name" placeholder="Teljes n√©v">
            <button onclick="register()" style="width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 5px; margin-top: 5px;">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <h4 id="my-display-name">...</h4>
            <button onclick="logout()" style="color: red; background: none; border: none;">Kijelentkez√©s</button>
        </div>
        <div id="chat-list"></div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <button onclick="sendRequest()" class="btn blue" style="flex:1">+ Jel√∂l√©s</button>
            <button onclick="createGroup()" class="btn blue" style="background:#2ecc71; flex:1">+ Csoport</button>
        </div>
    </div>

    <div id="main-chat">
        <div class="chat-header">
            <span id="chat-title">V√°lassz besz√©lget√©st</span>
            <div id="group-controls" style="display:none; gap: 5px; display: flex;">
                <button class="btn blue" onclick="inviteToGroup()">+ Tag</button>
                <button id="manage-members-btn" class="btn red" style="display:none;" onclick="manageMembers()">Tagok kezel√©se</button>
                <button id="leave-group-btn" class="btn red" onclick="leaveGroup()">Kil√©p√©s</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="m-input" placeholder="√úzenet..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" class="btn blue" style="padding:10px 20px;">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currUser = null, activeChat = null, adminEmail = null;

    onAuthStateChanged(auth, u => {
        if(u) { currUser = u; document.getElementById('login-screen').classList.remove('active'); initApp(); }
        else { document.getElementById('login-screen').classList.add('active'); }
    });

    function initApp() {
        document.getElementById('my-display-name').innerText = currUser.displayName;
        onSnapshot(doc(db, "users", currUser.email), s => {
            const data = s.data() || {};
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            (data.friends || []).forEach(f => {
                const d = document.createElement('div'); d.className="item"; d.innerHTML=`üë§ ${f.name}`;
                d.onclick=()=>openChat(f.email, f.name, false); list.appendChild(d);
            });
            (data.groups || []).forEach(g => {
                const d = document.createElement('div'); d.className="item"; d.innerHTML=`üë• ${g.name} <span class="group-tag">CSOP</span>`;
                d.onclick=()=>openChat(g.id, g.name, true); list.appendChild(d);
            });
        });
    }

    window.createGroup = async () => {
        const n = prompt("Csoport neve:"); if(!n) return;
        const id = "group_" + Date.now();
        await setDoc(doc(db, "chats", id), { name: n, isGroup: true, admin: currUser.email, members: [currUser.email] });
        await updateDoc(doc(db, "users", currUser.email), { groups: arrayUnion({ id: id, name: n }) });
    };

    window.manageMembers = async () => {
        const snap = await getDoc(doc(db, "chats", activeChat));
        const members = snap.data().members;
        let txt = "Csoport tagjai:\n";
        members.forEach((m, i) => txt += `${i}: ${m}\n`);
        const idx = prompt(txt + "\n√çrd be a sz√°mot a kidob√°shoz (vagy hagyd √ºresen):");
        if(idx !== null && members[idx]) {
            const victim = members[idx];
            if(victim === currUser.email) return alert("Magadat nem dobhatod ki!");
            await updateDoc(doc(db, "chats", activeChat), { members: arrayRemove(victim) });
            await updateDoc(doc(db, "users", victim), { groups: arrayRemove({ id: activeChat, name: document.getElementById('chat-title').innerText }) });
            alert(victim + " elt√°vol√≠tva.");
        }
    };

    window.leaveGroup = async () => {
        if(!confirm("Biztosan kil√©psz?")) return;
        await updateDoc(doc(db, "chats", activeChat), { members: arrayRemove(currUser.email) });
        await updateDoc(doc(db, "users", currUser.email), { groups: arrayRemove({ id: activeChat, name: document.getElementById('chat-title').innerText }) });
        location.reload();
    };

    async function openChat(id, name, isGroup) {
        activeChat = isGroup ? id : [currUser.email, id].sort().join("_");
        document.getElementById('chat-title').innerText = name;
        const controls = document.getElementById('group-controls');
        
        if(isGroup) {
            controls.style.display = "flex";
            const snap = await getDoc(doc(db, "chats", id));
            adminEmail = snap.data().admin;
            document.getElementById('manage-members-btn').style.display = (adminEmail === currUser.email) ? "block" : "none";
        } else { controls.style.display = "none"; }

        onSnapshot(query(collection(db, "chats", activeChat, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === currUser.email ? 'sent' : 'received'}`;
                div.innerHTML = `<b>${m.senderName}</b>${m.text}<span class="time">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.inviteToGroup = async () => {
        const mail = prompt("Email:"); if(!mail) return;
        const target = await getDoc(doc(db, "users", mail));
        if(target.exists()) {
            await updateDoc(doc(db, "users", mail), { groups: arrayUnion({ id: activeChat, name: document.getElementById('chat-title').innerText }) });
            await updateDoc(doc(db, "chats", activeChat), { members: arrayUnion(mail) });
            alert("Hozz√°adva!");
        }
    };

    window.sendMsg = async () => {
        const inp = document.getElementById('m-input'); if(!inp.value.trim()) return;
        await addDoc(collection(db, "chats", activeChat, "messages"), { text: inp.value, sender: currUser.email, senderName: currUser.displayName, time: Date.now() });
        inp.value = "";
    };

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    window.register = async () => {
        const e = document.getElementById('email').value, n = document.getElementById('reg-name').value;
        const res = await createUserWithEmailAndPassword(auth, e, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: n });
        await setDoc(doc(db, "users", e), { name: n, friends: [], groups: [], incomingRequests: [] });
        location.reload();
    };
    window.logout = () => signOut(auth);
</script>
</body>
</html>
