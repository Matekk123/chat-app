<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger - Full Fix</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        /* Oldals√°v */
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .profile-card { padding: 15px; text-align: center; border-bottom: 1px solid #eee; position: relative; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; transition: 0.3s; }
        .avatar:hover { opacity: 0.8; }
        
        #chat-list { flex: 1; overflow-y: auto; }
        .item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
        .item:hover { background: #f9f9f9; }
        .mini-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }

        /* Keres≈ë Modal */
        #search-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 380px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #search-results { flex: 1; overflow-y: auto; margin-top: 10px; }
        .search-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }

        /* Chat ter√ºlet */
        #main-chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #f0f2f5; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; position: relative; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; background: #0084ff; color: white; cursor: pointer; }
        .received { align-self: flex-start; background: white; color: black; border: 1px solid #ddd; }
        .time { font-size: 10px; align-self: flex-end; opacity: 0.6; margin-top: 4px; }
        
        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .blue { background: #0084ff; }
        .green { background: #2ecc71; }
        .red { background: #e74c3c; }
        .btn:active { transform: scale(0.95); }

        input { width: 100%; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; margin-bottom: 10px; }
        
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
    </style>
</head>
<body>

    <div id="search-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Ismer≈ës keres√©se</h3>
            <input type="text" id="user-search-input" placeholder="Kezdd el √≠rni a nevet..." oninput="searchUsers()">
            <div id="search-results"></div>
            <button class="btn red" onclick="toggleSearch(false)" style="margin-top:10px;">Bez√°r√°s</button>
        </div>
    </div>

    <div id="login-screen" class="active">
        <div style="width: 300px; text-align: center;">
            <h1 style="color: #0084ff; margin-bottom:20px;">BalassaMessenger</h1>
            <input type="email" id="email" placeholder="E-mail c√≠m">
            <input type="password" id="password" placeholder="Jelsz√≥">
            <button onclick="login()" class="btn blue" style="width:100%; padding:12px;">Bel√©p√©s</button>
            <hr style="margin:20px 0;">
            <input type="text" id="reg-name" placeholder="Teljes neved">
            <button onclick="register()" class="btn green" style="width:100%; padding:12px;">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <label title="Profilk√©p m√≥dos√≠t√°sa">
                <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                <input type="file" id="p-upload" hidden accept="image/*">
            </label>
            <h4 id="my-display-name" style="margin:10px 0 5px 0;">...</h4>
            <button onclick="logout()" style="color:red; background:none; border:none; cursor:pointer; font-size:12px;">Kijelentkez√©s</button>
        </div>
        
        <div id="request-panel" style="background:#e7f3ff; padding:10px; display:none; border-bottom:1px solid #0084ff;">
            <strong style="font-size:12px;">F√ºgg≈ëben l√©v≈ë k√©relmek:</strong>
            <div id="req-list"></div>
        </div>

        <div id="chat-list"></div>
        
        <div style="padding: 15px; display: flex; gap: 8px;">
            <button onclick="toggleSearch(true)" class="btn blue" style="flex:1">üîç Keres√©s</button>
            <button onclick="createGroup()" class="btn green" style="flex:1">+ Csoport</button>
        </div>
    </div>

    <div id="main-chat">
        <div id="chat-header" style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold; background:white; display:flex; justify-content:space-between; align-items:center;">
            <span id="chat-title">V√°lassz egy besz√©lget√©st</span>
            <div id="group-ops" style="display:none;">
                <button onclick="inviteToGroup()" class="btn blue" style="padding:5px 10px; font-size:11px;">+ Tag</button>
            </div>
        </div>
        <div id="messages"></div>
        <div style="padding:15px; display:flex; gap:10px; background:white; border-top:1px solid #ddd;">
            <label style="cursor:pointer; font-size:20px;">üìé<input type="file" id="f-upload" hidden accept="image/*"></label>
            <input type="text" id="m-input" placeholder="√çrj egy √ºzenetet..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" class="btn blue">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, arrayUnion, arrayRemove, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currUser = null, activeChat = null;

    onAuthStateChanged(auth, u => {
        if(u) { currUser = u; document.getElementById('login-screen').classList.remove('active'); initApp(); }
        else { document.getElementById('login-screen').classList.add('active'); }
    });

    function initApp() {
        document.getElementById('my-display-name').innerText = currUser.displayName;
        onSnapshot(doc(db, "users", currUser.email), s => {
            const data = s.data() || {};
            if(data.photoURL) document.getElementById('my-avatar').src = data.photoURL;

            const list = document.getElementById('chat-list'); list.innerHTML = "";
            (data.friends || []).forEach(f => {
                const d = document.createElement('div'); d.className="item";
                d.innerHTML=`<img src="${f.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="mini-avatar"> <span>${f.name}</span>`;
                d.onclick=()=>openChat(f.email, f.name, false); list.appendChild(d);
            });
            (data.groups || []).forEach(g => {
                const d = document.createElement('div'); d.className="item";
                d.innerHTML=`<div class="mini-avatar" style="background:#ddd; display:flex; align-items:center; justify-content:center;">üë•</div> <span>${g.name}</span>`;
                d.onclick=()=>openChat(g.id, g.name, true); list.appendChild(d);
            });

            const reqBox = document.getElementById('request-panel');
            const reqs = data.incomingRequests || [];
            if(reqs.length > 0) {
                reqBox.style.display = "block";
                document.getElementById('req-list').innerHTML = reqs.map(r => `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size:13px;">
                        <span>${r.name}</span>
                        <button onclick="handleReq('${r.email}','${r.name}','${r.photoURL}',true)" class="btn green" style="padding:3px 8px;">Elfogad</button>
                    </div>`).join('');
            } else { reqBox.style.display = "none"; }
        });
    }

    // --- PROFILK√âP FELT√ñLT√âS ---
    document.getElementById('p-upload').onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64 = reader.result;
            await updateDoc(doc(db, "users", currUser.email), { photoURL: base64 });
            document.getElementById('my-avatar').src = base64;
        };
    };

    // --- KERES√âS PROFILK√âPPEL ---
    window.toggleSearch = (show) => {
        document.getElementById('search-modal').style.display = show ? 'flex' : 'none';
        if(!show) document.getElementById('search-results').innerHTML = "";
    };

    window.searchUsers = async () => {
        const val = document.getElementById('user-search-input').value.trim();
        const resultsBox = document.getElementById('search-results');
        if(val.length < 2) { resultsBox.innerHTML = ""; return; }

        const q = query(collection(db, "users"), where("name", ">=", val), where("name", "<=", val + '\uf8ff'));
        const snap = await getDocs(q);
        resultsBox.innerHTML = "";
        
        snap.forEach(d => {
            const u = d.data();
            if(d.id === currUser.email) return;
            const div = document.createElement('div');
            div.className = "search-item";
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${u.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="mini-avatar">
                    <span>${u.name}</span>
                </div>
                <button onclick="sendRequest('${d.id}', '${u.name}', '${u.photoURL || ''}')" class="btn blue">Jel√∂l√©s</button>`;
            resultsBox.appendChild(div);
        });
    };

    window.sendRequest = async (email, name, photo) => {
        const myData = (await getDoc(doc(db, "users", currUser.email))).data();
        await updateDoc(doc(db, "users", email), {
            incomingRequests: arrayUnion({ email: currUser.email, name: currUser.displayName, photoURL: myData.photoURL || "" })
        });
        alert("K√©relem elk√ºldve!");
        toggleSearch(false);
    };

    window.handleReq = async (mail, name, photo, accept) => {
        const myRef = doc(db, "users", currUser.email);
        const myData = (await getDoc(myRef)).data();
        if(accept) {
            await updateDoc(myRef, { friends: arrayUnion({ email: mail, name: name, photoURL: photo }) });
            await updateDoc(doc(db, "users", mail), { friends: arrayUnion({ email: currUser.email, name: currUser.displayName, photoURL: myData.photoURL || "" }) });
        }
        await updateDoc(myRef, { incomingRequests: arrayRemove({ email: mail, name: name, photoURL: photo }) });
    };

    // --- CHAT √âS √úZENETEK ---
    function openChat(id, name, group) {
        activeChat = group ? id : [currUser.email, id].sort().join("_");
        document.getElementById('chat-title').innerText = name;
        document.getElementById('group-ops').style.display = group ? "block" : "none";

        onSnapshot(query(collection(db, "chats", activeChat, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMine = m.sender === currUser.email;
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'sent' : 'received'}`;
                
                let content = m.file ? `<img src="${m.file}" style="max-width:200px; border-radius:10px; cursor:pointer;" onclick="window.open('${m.file}')">` : m.text;
                let time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                div.innerHTML = `<b>${m.senderName}</b>${content}<span class="time">${time}</span>`;
                if(isMine) div.onclick = async () => { if(confirm("Visszavonod?")) await deleteDoc(doc(db, "chats", activeChat, "messages", d.id)); };
                
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMsg = async () => {
        const inp = document.getElementById('m-input');
        if(!inp.value.trim() || !activeChat) return;
        await addDoc(collection(db, "chats", activeChat, "messages"), {
            text: inp.value, sender: currUser.email, senderName: currUser.displayName, time: Date.now()
        });
        inp.value = "";
    };

    document.getElementById('f-upload').onchange = e => {
        const reader = new FileReader();
        reader.readAsDataURL(e.target.files[0]);
        reader.onload = async () => {
            await addDoc(collection(db, "chats", activeChat, "messages"), {
                file: reader.result, sender: currUser.email, senderName: currUser.displayName, time: Date.now()
            });
        };
    };

    // --- AUTH ---
    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    window.register = async () => {
        const e = document.getElementById('email').value, n = document.getElementById('reg-name').value;
        const res = await createUserWithEmailAndPassword(auth, e, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: n });
        await setDoc(doc(db, "users", e), { name: n, friends: [], groups: [], incomingRequests: [], photoURL: "" });
        location.reload();
    };
    window.logout = () => signOut(auth);
</script>
</body>
</html>
