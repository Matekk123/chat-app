<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger - Keres≈ë Funkci√≥</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .profile-card { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; }
        #chat-list { flex: 1; overflow-y: auto; }
        .item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
        #main-chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #f0f2f5; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; display: flex; flex-direction: column; }
        .sent { align-self: flex-end; background: #0084ff; color: white; }
        .received { align-self: flex-start; background: white; color: black; border: 1px solid #ddd; }
        
        /* KERES≈ê MODAL ST√çLUS */
        #search-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 350px; max-height: 80vh; display: flex; flex-direction: column; }
        #search-results { flex: 1; overflow-y: auto; margin-top: 10px; }
        .search-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }

        .btn { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; color: white; }
        .blue { background: #0084ff; }
        .green { background: #2ecc71; }
        .red { background: #e74c3c; }
        input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; margin-bottom: 10px; }
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
    </style>
</head>
<body>

    <div id="search-modal">
        <div class="modal-content">
            <h3>Felhaszn√°l√≥ keres√©se</h3>
            <input type="text" id="user-search-input" placeholder="√çrd be a nevet..." oninput="searchUsers()">
            <div id="search-results"></div>
            <button class="btn red" onclick="toggleSearch(false)">Bez√°r√°s</button>
        </div>
    </div>

    <div id="login-screen" class="active">
        <div style="width: 280px; text-align: center;">
            <h2 style="color: #0084ff;">BalassaMessenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Jelsz√≥">
            <button onclick="login()" class="btn blue" style="width:100%">Bel√©p√©s</button>
            <hr>
            <input type="text" id="reg-name" placeholder="Teljes n√©v">
            <button onclick="register()" class="btn green" style="width:100%">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <h4 id="my-display-name">...</h4>
            <button onclick="logout()" style="color:red; background:none; border:none; cursor:pointer;">Kijelentkez√©s</button>
        </div>
        
        <div id="request-panel" style="background:#e7f3ff; padding:10px; display:none;">
            <strong>√öj felk√©r√©sek:</strong>
            <div id="req-list"></div>
        </div>

        <div id="chat-list"></div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <button onclick="toggleSearch(true)" class="btn blue" style="flex:1">üîç Keres√©s</button>
            <button onclick="createGroup()" class="btn green" style="flex:1">+ Csoport</button>
        </div>
    </div>

    <div id="main-chat">
        <div id="chat-header" style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold; background:white;">V√°lassz egy besz√©lget√©st</div>
        <div id="messages"></div>
        <div style="padding:15px; display:flex; gap:10px; background:white;">
            <input type="text" id="m-input" placeholder="√úzenet..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" class="btn blue">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, arrayUnion, arrayRemove, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currUser = null, activeChat = null;

    onAuthStateChanged(auth, u => {
        if(u) { currUser = u; document.getElementById('login-screen').classList.remove('active'); initApp(); }
        else { document.getElementById('login-screen').classList.add('active'); }
    });

    function initApp() {
        document.getElementById('my-display-name').innerText = currUser.displayName;
        onSnapshot(doc(db, "users", currUser.email), s => {
            const data = s.data() || {};
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            (data.friends || []).forEach(f => {
                const d = document.createElement('div'); d.className="item"; d.innerHTML=`üë§ ${f.name}`;
                d.onclick=()=>openChat(f.email, f.name, false); list.appendChild(d);
            });
            (data.groups || []).forEach(g => {
                const d = document.createElement('div'); d.className="item"; d.innerHTML=`üë• ${g.name}`;
                d.onclick=()=>openChat(g.id, g.name, true); list.appendChild(d);
            });

            // K√©relmek list√°z√°sa
            const reqBox = document.getElementById('request-panel');
            const reqs = data.incomingRequests || [];
            if(reqs.length > 0) {
                reqBox.style.display = "block";
                document.getElementById('req-list').innerHTML = reqs.map(r => `
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span>${r.name}</span>
                        <button onclick="handleReq('${r.email}','${r.name}',true)" class="btn green" style="padding:2px 5px">‚úî</button>
                    </div>`).join('');
            } else { reqBox.style.display = "none"; }
        });
    }

    // --- KERES√âS FUNKCI√ì ---
    window.toggleSearch = (show) => {
        document.getElementById('search-modal').style.display = show ? 'flex' : 'none';
        if(!show) document.getElementById('search-results').innerHTML = "";
    };

    window.searchUsers = async () => {
        const val = document.getElementById('user-search-input').value.trim();
        const resultsBox = document.getElementById('search-results');
        if(val.length < 2) { resultsBox.innerHTML = ""; return; }

        const q = query(collection(db, "users"), where("name", ">=", val), where("name", "<=", val + '\uf8ff'));
        const snap = await getDocs(q);
        resultsBox.innerHTML = "";
        
        snap.forEach(d => {
            const userData = d.data();
            const userEmail = d.id;
            if(userEmail === currUser.email) return; // Magunkat ne tal√°ljuk meg

            const div = document.createElement('div');
            div.className = "search-item";
            div.innerHTML = `<span>${userData.name}</span> 
                             <button onclick="sendRequest('${userEmail}', '${userData.name}')" class="btn blue">Jel√∂l√©s</button>`;
            resultsBox.appendChild(div);
        });
    };

    window.sendRequest = async (email, name) => {
        await updateDoc(doc(db, "users", email), {
            incomingRequests: arrayUnion({ email: currUser.email, name: currUser.displayName })
        });
        alert("Bar√°tk√©relem elk√ºldve " + name + " r√©sz√©re!");
        toggleSearch(false);
    };

    window.handleReq = async (mail, name, accept) => {
        const myRef = doc(db, "users", currUser.email);
        if(accept) {
            await updateDoc(myRef, { friends: arrayUnion({ email: mail, name: name }) });
            await updateDoc(doc(db, "users", mail), { friends: arrayUnion({ email: currUser.email, name: currUser.displayName }) });
        }
        await updateDoc(myRef, { incomingRequests: arrayRemove({ email: mail, name: name }) });
    };

    // --- CHAT √âS √úZENETEK ---
    function openChat(id, name, group) {
        activeChat = group ? id : [currUser.email, id].sort().join("_");
        document.getElementById('chat-header').innerText = name;
        onSnapshot(query(collection(db, "chats", activeChat, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === currUser.email ? 'sent' : 'received'}`;
                div.innerHTML = `<b>${m.senderName}</b>${m.text}`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMsg = async () => {
        const inp = document.getElementById('m-input');
        if(!inp.value.trim() || !activeChat) return;
        await addDoc(collection(db, "chats", activeChat, "messages"), {
            text: inp.value, sender: currUser.email, senderName: currUser.displayName, time: Date.now()
        });
        inp.value = "";
    };

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    window.register = async () => {
        const e = document.getElementById('email').value, n = document.getElementById('reg-name').value;
        const res = await createUserWithEmailAndPassword(auth, e, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: n });
        await setDoc(doc(db, "users", e), { name: n, friends: [], groups: [], incomingRequests: [] });
        location.reload();
    };
    window.logout = () => signOut(auth);
</script>
</body>
</html>
