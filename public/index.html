<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger - Friend Request Edition</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; }
        .profile-card { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; }
        .item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9; position: relative; }
        .item:hover { background: #f0f2f5; }
        .item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        /* BarÃ¡tkÃ©relem panel */
        #request-panel { padding: 10px; background: #e7f3ff; border-bottom: 1px solid #ddd; display: none; }
        .req-item { display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 5px; background: white; padding: 5px; border-radius: 5px; }

        #main-chat { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
        .msg { display: flex; gap: 8px; max-width: 75%; cursor: pointer; }
        .sent { align-self: flex-end; flex-direction: row-reverse; }
        .received { align-self: flex-start; }
        .msg-content { padding: 10px 14px; border-radius: 18px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent .msg-content { background: #0084ff; color: white; }
        .received .msg-content { background: white; color: black; }
        .shared-img { max-width: 250px; border-radius: 10px; display: block; margin-top: 5px; cursor: pointer; }

        .input-area { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; background: white; }
        #msg-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }

        #call-screen { position: absolute; inset: 0; background: #1c1e21; z-index: 1000; display: none; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; bottom: 20px; right: 20px; border-radius: 8px; border: 2px solid white; }
        
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
    </style>
</head>
<body>

    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="dialtone" src="https://assets.mixkit.co/active_storage/sfx/1358/1358-preview.mp3" loop></audio>

    <div id="login-screen" class="active">
        <div style="width:300px; text-align:center;">
            <h2 style="color:#0084ff">BalassaMessenger</h2>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="password" id="password" placeholder="JelszÃ³" style="width:100%; padding:10px; margin-bottom:10px;">
            <button onclick="login()" style="width:100%; padding:12px; background:#0084ff; color:white; border:none; border-radius:5px; cursor:pointer;">BelÃ©pÃ©s</button>
            <hr>
            <input type="text" id="reg-name" placeholder="Teljes nÃ©v" style="width:100%; padding:10px; margin-bottom:10px;">
            <button onclick="register()" style="width:100%; padding:12px; background:#2ecc71; color:white; border:none; border-radius:5px; cursor:pointer;">RegisztrÃ¡ciÃ³</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <label><img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"><input type="file" id="p-upload" hidden accept="image/*"></label>
            <h3 id="display-name">...</h3>
            <button onclick="logout()" style="color:red; background:none; border:none; cursor:pointer;">KijelentkezÃ©s</button>
        </div>
        
        <div id="request-panel">
            <strong style="font-size: 12px;">Ãšj felkÃ©rÃ©sek:</strong>
            <div id="request-list"></div>
        </div>

        <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
        
        <div style="padding:10px; display:flex; gap:5px;">
            <button onclick="sendFriendRequest()" style="flex:1; padding:10px; background:#0084ff; color:white; border:none; border-radius:5px; cursor:pointer;">+ JelÃ¶lÃ©s</button>
            <button onclick="createGroup()" style="flex:1; padding:10px; background:#2ecc71; color:white; border:none; border-radius:5px; cursor:pointer;">+ Csoport</button>
        </div>
    </div>

    <div id="main-chat">
        <div class="chat-header" style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
            <span id="chat-title">VÃ¡lassz egy chatet</span>
            <div id="call-btns" style="display:none; gap:10px;">
                <button onclick="initCall(true)" style="background:none; border:none; font-size:22px; cursor:pointer;">ðŸ“¹</button>
                <button onclick="initCall(false)" style="background:none; border:none; font-size:22px; cursor:pointer;">ðŸ“ž</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <label style="cursor:pointer; font-size:22px;">ðŸ“Ž<input type="file" id="file-input" hidden accept="image/*"></label>
            <input type="text" id="msg-input" placeholder="Ãœzenet..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="color:#0084ff; border:none; background:none; font-weight:bold; cursor:pointer;">KÃœLDÃ‰S</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, where, arrayUnion, deleteDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null, activeChatId = null, targetEmail = null;
    const photoCache = {};

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('display-name').innerText = user.displayName;
            startApp();
        } else {
            document.getElementById('login-screen').classList.add('active');
        }
    });

    function startApp() {
        // FelhasznÃ¡lÃ³i adatok, BarÃ¡tok Ã©s KÃ©relmek figyelÃ©se
        onSnapshot(doc(db, "users", currentUser.email), s => {
            const data = s.data();
            if(!data) return;

            document.getElementById('my-avatar').src = data.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            
            // BarÃ¡tlista frissÃ­tÃ©se
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            (data.friends || []).forEach(f => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<img src="${photoCache[f.email] || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"> <span>${f.name}</span>`;
                div.onclick = () => openChat(f.email, f.name, false);
                list.appendChild(div);
                
                getDoc(doc(db, "users", f.email)).then(snap => {
                    if(snap.exists()) {
                        photoCache[f.email] = snap.data().photoURL;
                        div.querySelector('img').src = photoCache[f.email] || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                    }
                });
            });

            // Csoportok
            (data.groups || []).forEach(g => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<div style="width:40px;height:40px;background:#ddd;border-radius:50%;display:flex;align-items:center;justify-content:center;">ðŸ‘¥</div> <span>${g.name}</span>`;
                div.onclick = () => openChat(g.id, g.name, true);
                list.appendChild(div);
            });

            // BarÃ¡tkÃ©relmek panel kezelÃ©se
            const reqList = document.getElementById('request-list');
            const reqPanel = document.getElementById('request-panel');
            const requests = data.incomingRequests || [];
            
            if(requests.length > 0) {
                reqPanel.style.display = "block";
                reqList.innerHTML = "";
                requests.forEach(req => {
                    const d = document.createElement('div');
                    d.className = "req-item";
                    d.innerHTML = `<span>${req.name}</span> 
                        <div>
                            <button onclick="acceptFriend('${req.email}', '${req.name}')" style="background:#2ecc71; border:none; color:white; border-radius:3px;">âœ”</button>
                            <button onclick="rejectFriend('${req.email}')" style="background:#e74c3c; border:none; color:white; border-radius:3px;">âœ˜</button>
                        </div>`;
                    reqList.appendChild(d);
                });
            } else {
                reqPanel.style.display = "none";
            }
        });
    }

    // --- BARÃTKÃ‰RELEM FUNKCIÃ“K ---
    window.sendFriendRequest = async () => {
        const email = prompt("Ki az akit bejelÃ¶lnÃ©l? (Email cÃ­m):");
        if(!email || email === currentUser.email) return;

        const targetRef = doc(db, "users", email);
        const targetSnap = await getDoc(targetRef);

        if(targetSnap.exists()) {
            await updateDoc(targetRef, {
                incomingRequests: arrayUnion({ email: currentUser.email, name: currentUser.displayName })
            });
            alert("BarÃ¡tkÃ©relem elkÃ¼ldve!");
        } else {
            alert("Nincs ilyen felhasznÃ¡lÃ³ regisztrÃ¡lva!");
        }
    };

    window.acceptFriend = async (email, name) => {
        const myRef = doc(db, "users", currentUser.email);
        const hisRef = doc(db, "users", email);

        // HozzÃ¡adÃ¡s mindkÃ©t fÃ©lhez
        await updateDoc(myRef, {
            friends: arrayUnion({ email: email, name: name }),
            incomingRequests: arrayRemove({ email: email, name: name })
        });
        await updateDoc(hisRef, {
            friends: arrayUnion({ email: currentUser.email, name: currentUser.displayName })
        });
        alert("Most mÃ¡r barÃ¡tok vagytok!");
    };

    window.rejectFriend = async (email) => {
        const myRef = doc(db, "users", currentUser.email);
        const data = (await getDoc(myRef)).data();
        const request = data.incomingRequests.find(r => r.email === email);
        
        await updateDoc(myRef, {
            incomingRequests: arrayRemove(request)
        });
    };

    // --- CHAT & ÃœZENETEK ---
    function openChat(id, name, isGroup) {
        targetEmail = isGroup ? null : id;
        activeChatId = isGroup ? id : [currentUser.email, id].sort().join("_");
        document.getElementById('chat-title').innerText = name;
        document.getElementById('call-btns').style.display = isGroup ? "none" : "flex";
        
        onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMine = m.sender === currentUser.email;
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'sent' : 'received'}`;
                let content = m.file ? `<img src="${m.file}" class="shared-img" onclick="window.open('${m.file}')">` : m.text;
                div.innerHTML = `<div class="msg-content"><b>${m.senderName}</b><br>${content}</div>`;
                
                div.onclick = async () => {
                    if(isMine && confirm("Visszavonod?")) await deleteDoc(doc(db, "chats", activeChatId, "messages", d.id));
                };
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMessage = async () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !activeChatId) return;
        await addDoc(collection(db, "chats", activeChatId, "messages"), {
            text: inp.value,
            sender: currentUser.email,
            senderName: currentUser.displayName,
            time: Date.now()
        });
        inp.value = "";
    };

    document.getElementById('file-input').onchange = e => {
        const reader = new FileReader();
        reader.readAsDataURL(e.target.files[0]);
        reader.onload = async () => {
            await addDoc(collection(db, "chats", activeChatId, "messages"), {
                file: reader.result,
                sender: currentUser.email,
                senderName: currentUser.displayName,
                time: Date.now()
            });
        };
    };

    window.createGroup = async () => {
        const name = prompt("Csoport neve:");
        if(!name) return;
        const id = "group_" + Date.now();
        await setDoc(doc(db, "chats", id), { name, owner: currentUser.email });
        await updateDoc(doc(db, "users", currentUser.email), { groups: arrayUnion({ id, name }) });
    };

    // Auth Ã©s Profil
    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
    window.register = async () => {
        const email = document.getElementById('email').value;
        const name = document.getElementById('reg-name').value;
        const res = await createUserWithEmailAndPassword(auth, email, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: name });
        await setDoc(doc(db, "users", email), { name, friends: [], groups: [], incomingRequests: [], photoURL: "" });
        location.reload();
    };
    window.logout = () => signOut(auth);
    document.getElementById('p-upload').onchange = e => {
        const r = new FileReader(); r.readAsDataURL(e.target.files[0]);
        r.onload = async () => await updateDoc(doc(db, "users", currentUser.email), { photoURL: r.result });
    };
</script>
</body>
</html>
