<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saj√°t Chat & Telefon</title>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        #app { background: white; width: 100%; max-width: 400px; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; height: 90vh; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #uzenetek { flex: 1; overflow-y: auto; padding: 15px; background: #efe7dd; display: flex; flex-direction: column; }
        .beviteli-mezok { padding: 15px; display: flex; gap: 5px; flex-direction: column; background: #f0f0f0; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 5px; color: white; font-weight: bold; font-size: 16px; }
        .kuld-btn { background: #25d366; margin-bottom: 5px; }
        .hivas-btn { background: #34b7f1; }
        .uzenet { margin: 5px 0; padding: 8px 12px; border-radius: 8px; max-width: 80%; }
        .sajat { background: #dcf8c6; align-self: flex-end; }
        .mas { background: white; align-self: flex-start; }
    </style>
</head>
<body>

<div id="app">
    <div id="uzenetek"></div>
    <div class="beviteli-mezok">
        <input type="text" id="nev" placeholder="Neved...">
        <input type="text" id="szoveg" placeholder="√úzenet...">
        <button class="kuld-btn" onclick="kuld()">K√ºld√©s</button>
        <button class="hivas-btn" id="hivasBtn">üìû H√≠v√°s ind√≠t√°sa</button>
    </div>
</div>

<audio id="tavoliHang" autoplay></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
let localStream, peerConnection;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// F√ºggv√©ny az √ºzenet bubor√©k megjelen√≠t√©s√©re
function megjelenitUzenetet(adat) {
    const uzenetekDiv = document.getElementById('uzenetek');
    const div = document.createElement('div');
    // Megn√©zz√ºk, hogy mi k√ºldt√ºk-e (ha a n√©v egyezik a mez≈ëbe √≠rt n√©vvel)
    const sajatE = adat.nev === (document.getElementById('nev').value || "N√©vtelen");
    
    div.className = 'uzenet ' + (sajatE ? 'sajat' : 'mas');
    div.innerHTML = `<strong>${adat.nev}:</strong> ${adat.szoveg}`;
    
    uzenetekDiv.appendChild(div);
    uzenetekDiv.scrollTop = uzenetekDiv.scrollHeight; // Automatikus g√∂rget√©s alulra
}

// Bel√©p√©skor megkapjuk a r√©gi √ºzeneteket
socket.on('korabbi-uzenetek', (elozmenyek) => {
    elozmenyek.forEach(adat => {
        megjelenitUzenetet(adat);
    });
});

// Amikor √∫j √ºzenet √©rkezik valakit≈ël (vagy t≈ël√ºnk)
socket.on('uzenet', (adat) => {
    megjelenitUzenetet(adat);
});

function kuld() {
    const nev = document.getElementById('nev').value || "N√©vtelen";
    const szoveg = document.getElementById('szoveg').value;
    if(szoveg) {
        socket.emit('uzenet', { nev, szoveg });
        document.getElementById('szoveg').value = "";
    }
}

// --- H√≠v√°s r√©sz v√°ltozatlan ---
document.getElementById('hivasBtn').onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupPeerConnection();
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('hivas-ajanlat', offer);
        document.getElementById('hivasBtn').innerText = "H√≠v√°s folyamatban...";
    } catch (e) { alert("Mikrofon hiba!"); }
};

function setupPeerConnection() {
    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
    peerConnection.ontrack = e => document.getElementById('tavoliHang').srcObject = e.streams[0];
    peerConnection.onicecandidate = e => e.candidate && socket.emit('ice-candidate', e.candidate);
}

socket.on('hivas-ajanlat', async (offer) => {
    if(confirm("Bej√∂v≈ë h√≠v√°s! Elfogadod?")) {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('hivas-valasz', answer);
    }
});

socket.on('hivas-valasz', a => peerConnection.setRemoteDescription(new RTCSessionDescription(a)));
socket.on('ice-candidate', c => peerConnection && peerConnection.addIceCandidate(new RTCIceCandidate(c)));
</script>
</body>
</html>