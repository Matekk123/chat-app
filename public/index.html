<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .profile-card { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid #0084ff; cursor: pointer; background: #eee; }
        
        #main-chat { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        .chat-header { padding: 15px; border-bottom: 1px solid #ddd; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }

        /* H√≠v√°s Overlay */
        #call-screen {
            position: absolute; inset: 0; background: #1c1e21; z-index: 1000;
            display: none; flex-direction: column;
        }
        .video-box { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; height: 160px; position: absolute; bottom: 20px; right: 20px; border: 2px solid #fff; border-radius: 8px; background: #333; }
        
        .call-bar { height: 100px; background: #242526; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; color: white; }
        .hangup { background: #ff3b30; }
        .control { background: #4e4e4e; }

        /* √ârtes√≠t√©s */
        #incoming-call {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #0084ff; color: white; padding: 15px 25px; border-radius: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; display: none; gap: 15px; align-items: center;
        }
        
        /* √úzenetek st√≠lusa */
        .msg { padding: 10px; border-radius: 18px; max-width: 70%; font-size: 14px; cursor: pointer; }
        .sent { background: #0084ff; color: white; align-self: flex-end; }
        .received { background: white; color: black; align-self: flex-start; }
        .msg-header { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .msg-avatar { width: 24px; height: 24px; border-radius: 50%; }

        .input-area { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        
        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
    </style>
</head>
<body>

    <div id="incoming-call">
        <span id="caller-info">H√≠v√°s √©rkezik...</span>
        <button onclick="answerCall()" style="background:#42b72a; border:none; color:white; padding:8px 15px; border-radius:20px; cursor:pointer;">Felv√©tel</button>
        <button onclick="rejectCall()" style="background:#ff3b30; border:none; color:white; padding:8px 15px; border-radius:20px; cursor:pointer;">Elutas√≠t√°s</button>
    </div>

    <div id="call-screen">
        <div class="video-box">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="call-bar">
            <button class="c-btn control" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
            <button class="c-btn control" id="cam-btn" onclick="toggleCam()">üìπ</button>
            <button class="c-btn hangup" onclick="endCall()">üìû</button>
        </div>
    </div>

    <div id="login-screen" class="active">
        <div style="width:300px; text-align:center;">
            <h2 style="color:#0084ff">BalassaMessenger</h2>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:5px;">
            <input type="password" id="password" placeholder="Jelsz√≥" style="width:100%; padding:10px; margin-bottom:5px;">
            <button onclick="login()" style="width:100%; padding:10px; background:#0084ff; color:white; border:none; border-radius:5px; cursor:pointer;">Bel√©p√©s</button>
            <p>vagy</p>
            <input type="text" id="reg-name" placeholder="Teljes n√©v" style="width:100%; padding:10px; margin-bottom:5px;">
            <button onclick="register()" style="width:100%; padding:10px; background:#42b72a; color:white; border:none; border-radius:5px; cursor:pointer;">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <label><img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"><input type="file" id="p-upload" hidden accept="image/*"></label>
            <h3 id="my-name">...</h3>
            <button onclick="logout()" style="color:red; border:none; background:none; cursor:pointer;">Kil√©p√©s</button>
        </div>
        <div id="friend-list" class="item-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="addFriend()" style="margin:10px; padding:10px; cursor:pointer;">+ Bar√°t hozz√°ad√°sa</button>
    </div>

    <div id="main-chat">
        <div class="chat-header">
            <span id="chat-title">V√°lassz besz√©lget√©st</span>
            <div id="call-btns" style="display:none; gap:10px;">
                <button onclick="initiateCall(true)" style="background:none; border:none; font-size:22px; cursor:pointer;">üìπ</button>
                <button onclick="initiateCall(false)" style="background:none; border:none; font-size:22px; cursor:pointer;">üìû</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="√úzenet..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="color:#0084ff; border:none; background:none; font-weight:bold; cursor:pointer;">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, where, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null, activeChatId = null, targetEmail = null;
    let localStream = null, remoteStream = null, pc = null;
    const photoCache = {};

    const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    // --- PROFIL & √úZENET KEZEL√âS ---
    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('my-name').innerText = user.displayName;
            listenToCalls();
            syncSidebar();
            syncPhoto(user.email);
        } else {
            document.getElementById('login-screen').classList.add('active');
        }
    });

    function syncPhoto(email) {
        if(!email) return;
        onSnapshot(doc(db, "users", email), s => {
            const url = s.exists() ? s.data().photoURL : "";
            photoCache[email] = url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.querySelectorAll(`.u-img-${email.replace(/[@.]/g, '-')}`).forEach(i => i.src = photoCache[email]);
            if(email === currentUser?.email) document.getElementById('my-avatar').src = photoCache[email];
        });
    }

    function syncSidebar() {
        onSnapshot(doc(db, "users", currentUser.email), snap => {
            const list = document.getElementById('friend-list'); list.innerHTML = "";
            (snap.data()?.friends || []).forEach(f => {
                const div = document.createElement('div'); div.style.padding="10px"; div.style.cursor="pointer";
                div.innerHTML = `<span>${f.name}</span>`;
                div.onclick = () => {
                    targetEmail = f.email;
                    activeChatId = [currentUser.email, f.email].sort().join("_");
                    document.getElementById('chat-title').innerText = f.name;
                    document.getElementById('call-btns').style.display = "flex";
                    loadMessages();
                };
                list.appendChild(div);
            });
        });
    }

    function loadMessages() {
        onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc")), snap => {
            const c = document.getElementById('messages'); c.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === currentUser.email ? 'sent' : 'received'}`;
                div.onclick = () => handleMsgClick(d.id, m.sender, m.time);
                div.innerHTML = `<small>${m.senderName}</small><div>${m.text}</div>`;
                c.appendChild(div);
            });
            c.scrollTop = c.scrollHeight;
        });
    }

    window.handleMsgClick = async (id, sender, time) => {
        const t = new Date(time).toLocaleTimeString();
        if(sender === currentUser.email && confirm(`K√ºldve: ${t}\nVisszavonod?`)) await deleteDoc(doc(db, "chats", activeChatId, "messages", id));
        else if(sender !== currentUser.email) alert(`K√ºldve: ${t}`);
    };

    window.sendMessage = async () => {
        const i = document.getElementById('msg-input'); if(!i.value) return;
        await addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: currentUser.email, senderName: currentUser.displayName, time: Date.now() });
        i.value = "";
    };

    // --- WEBRTC H√çV√ÅS LOGIKA (SIGNALING) ---

    let currentCallId = null;

    // Figyelj√ºk ha h√≠vnak minket
    function listenToCalls() {
        onSnapshot(collection(db, "calls"), snap => {
            snap.docChanges().forEach(async change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    if (data.target === currentUser.email && data.status === "ringing") {
                        currentCallId = change.doc.id;
                        document.getElementById('caller-info').innerText = data.callerName + " h√≠v...";
                        document.getElementById('incoming-call').style.display = "flex";
                    }
                }
            });
        });
    }

    window.initiateCall = async (video) => {
        const callDoc = doc(collection(db, "calls"));
        currentCallId = callDoc.id;

        localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
        remoteStream = new MediaStream();
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('remote-video').srcObject = remoteStream;

        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);

        await setDoc(callDoc, { 
            caller: currentUser.email, callerName: currentUser.displayName, 
            target: targetEmail, status: "ringing", 
            offer: { type: offerDescription.type, sdp: offerDescription.sdp } 
        });

        document.getElementById('call-screen').style.display = "flex";

        // V√°rjuk a v√°laszt
        onSnapshot(callDoc, snap => {
            const data = snap.data();
            if (data?.answer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
            if (data?.status === "ended") stopAll();
        });

        // ICE Candidates gy≈±jt√©se
        const candidatesCol = collection(db, "calls", currentCallId, "callerCandidates");
        pc.onicecandidate = e => e.candidate && addDoc(candidatesCol, e.candidate.toJSON());
        onSnapshot(collection(db, "calls", currentCallId, "targetCandidates"), s => {
            s.docChanges().forEach(c => c.type === "added" && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
        });
    };

    window.answerCall = async () => {
        document.getElementById('incoming-call').style.display = "none";
        document.getElementById('call-screen').style.display = "flex";

        const callDoc = doc(db, "calls", currentCallId);
        const callData = (await getDoc(callDoc)).data();

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        remoteStream = new MediaStream();
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('remote-video').srcObject = remoteStream;

        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

        await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp }, status: "active" });

        const targetCandidates = collection(db, "calls", currentCallId, "targetCandidates");
        pc.onicecandidate = e => e.candidate && addDoc(targetCandidates, e.candidate.toJSON());
        onSnapshot(collection(db, "calls", currentCallId, "callerCandidates"), s => {
            s.docChanges().forEach(c => c.type === "added" && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
        });

        onSnapshot(callDoc, snap => snap.data()?.status === "ended" && stopAll());
    };

    window.toggleCam = () => {
        const v = localStream.getVideoTracks()[0];
        v.enabled = !v.enabled;
        document.getElementById('cam-btn').innerText = v.enabled ? "üìπ" : "üö´";
    };

    window.toggleMic = () => {
        const a = localStream.getAudioTracks()[0];
        a.enabled = !a.enabled;
        document.getElementById('mic-btn').innerText = a.enabled ? "üéôÔ∏è" : "üîá";
    };

    window.endCall = async () => {
        await updateDoc(doc(db, "calls", currentCallId), { status: "ended" });
        stopAll();
    };

    function stopAll() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(pc) pc.close();
        document.getElementById('call-screen').style.display = "none";
        document.getElementById('incoming-call').style.display = "none";
    }

    window.rejectCall = async () => {
        await updateDoc(doc(db, "calls", currentCallId), { status: "ended" });
        document.getElementById('incoming-call').style.display = "none";
    };

    // Alap login/reg (kor√°bbiakb√≥l)
    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    window.register = async () => {
        const res = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: document.getElementById('reg-name').value });
        await setDoc(doc(db, "users", res.user.email), { name: document.getElementById('reg-name').value, friends: [], photoURL: "" });
        location.reload();
    };
    window.logout = () => signOut(auth);
    window.addFriend = async () => {
        const e = prompt("Bar√°t email:");
        const s = await getDoc(doc(db, "users", e));
        if(s.exists()) await updateDoc(doc(db, "users", currentUser.email), { friends: arrayUnion({ email: e, name: s.data().name }) });
    };
    document.getElementById('p-upload').onchange = async e => {
        const r = new FileReader(); r.readAsDataURL(e.target.files[0]);
        r.onload = async () => await updateDoc(doc(db, "users", currentUser.email), { photoURL: r.result });
    };

</script>
</body>
</html>
