<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalassaMessenger - Stabil Verzi√≥</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; }
        .profile-card { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #0084ff; cursor: pointer; background: #eee; }
        
        /* Chat */
        #main-chat { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        .chat-header { padding: 15px; border-bottom: 1px solid #ddd; font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: white; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }

        /* √úzenetek */
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 14px; position: relative; cursor: pointer; }
        .sent { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: white; color: black; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 11px; font-weight: bold; }
        .msg-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }

        /* H√≠v√°s k√©perny≈ë */
        #call-screen { position: absolute; inset: 0; background: #1c1e21; z-index: 1000; display: none; flex-direction: column; }
        .video-grid { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: black; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 130px; height: 180px; position: absolute; bottom: 20px; right: 20px; border: 2px solid white; border-radius: 10px; object-fit: cover; background: #333; }
        .call-controls { height: 100px; background: #242526; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .c-btn { width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; color: white; transition: 0.2s; }
        .hangup { background: #ff3b30; }
        .hangup:hover { background: #d63027; }
        .opt { background: #4e4e4e; }

        /* √ârtes√≠t√©s */
        #incoming-call-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #0084ff; color: white; padding: 15px 25px; border-radius: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 2000; display: none; gap: 15px; align-items: center; }

        .input-area { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: #f0f2f5; }

        #login-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; visibility: hidden; }
        #login-screen.active { visibility: visible; }
    </style>
</head>
<body>

    <div id="incoming-call-box">
        <strong id="caller-name-label">H√≠v√°s...</strong>
        <button onclick="answerCall()" style="background:#42b72a; border:none; color:white; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">FELVESZEM</button>
        <button onclick="rejectCall()" style="background:#ff3b30; border:none; color:white; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">ELUTAS√çT</button>
    </div>

    <div id="call-screen">
        <div class="video-grid">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="call-controls">
            <button class="c-btn opt" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
            <button class="c-btn opt" id="cam-btn" onclick="toggleCam()">üìπ</button>
            <button class="c-btn hangup" onclick="endCall()">üìû</button>
        </div>
    </div>

    <div id="login-screen" class="active">
        <div style="width:320px; text-align:center;">
            <h1 style="color:#0084ff; margin-bottom:20px;">BalassaMessenger</h1>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <input type="password" id="password" placeholder="Jelsz√≥" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="login()" style="width:100%; padding:12px; background:#0084ff; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Bejelentkez√©s</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <input type="text" id="reg-name" placeholder="Teljes neved" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="register()" style="width:100%; padding:12px; background:#42b72a; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Regisztr√°ci√≥</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="profile-card">
            <label>
                <img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                <input type="file" id="p-upload" hidden accept="image/*">
            </label>
            <h3 id="my-display-name" style="margin:10px 0 5px 0;">...</h3>
            <button onclick="logout()" style="color:#ff3b30; border:none; background:none; cursor:pointer; font-weight:bold; font-size:12px;">KIJELENTKEZ√âS</button>
        </div>
        <div id="friend-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="addFriend()" style="margin:15px; padding:12px; background:#e7f3ff; color:#0084ff; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">+ √öJ BAR√ÅT</button>
    </div>

    <div id="main-chat">
        <div class="chat-header">
            <span id="chat-title">V√°lassz egy bar√°tot</span>
            <div id="call-tools" style="display:none; gap:15px;">
                <button onclick="initCall(true)" style="background:none; border:none; font-size:24px; cursor:pointer;">üìπ</button>
                <button onclick="initCall(false)" style="background:none; border:none; font-size:24px; cursor:pointer;">üìû</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="√úzenet..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="color:#0084ff; border:none; background:none; font-weight:bold; cursor:pointer; padding:0 10px;">K√úLD√âS</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, addDoc, orderBy, where, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAQkoqTNUiJlXJeCOgZ_PrVjafgRdj65UA",
        authDomain: "sajatmesenger.firebaseapp.com",
        projectId: "sajatmesenger",
        storageBucket: "sajatmesenger.firebasestorage.app",
        messagingSenderId: "916403691764",
        appId: "1:916403691764:web:51fd4ec82de42c63917ea1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null, activeChatId = null, selectedFriendEmail = null;
    let localStream = null, pc = null, currentCallId = null;
    const photoCache = {};

    const rtcConfig = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    // --- FELHASZN√ÅL√ìI √ÅLLAPOT ---
    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('my-display-name').innerText = user.displayName;
            startSyncing();
        } else {
            document.getElementById('login-screen').classList.add('active');
        }
    });

    function startSyncing() {
        // Saj√°t k√©p
        onSnapshot(doc(db, "users", currentUser.email), s => {
            const url = s.data()?.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.getElementById('my-avatar').src = url;
            photoCache[currentUser.email] = url;
        });

        // Bar√°t lista
        onSnapshot(doc(db, "users", currentUser.email), s => {
            const list = document.getElementById('friend-list'); list.innerHTML = "";
            (s.data()?.friends || []).forEach(f => {
                const div = document.createElement('div');
                div.style.cssText = "padding:15px; border-bottom:1px solid #f5f5f5; cursor:pointer; display:flex; align-items:center; gap:10px;";
                div.innerHTML = `<strong>${f.name}</strong>`;
                div.onclick = () => openFriendChat(f.email, f.name);
                list.appendChild(div);
            });
        });

        // H√≠v√°s figyel√©s
        onSnapshot(collection(db, "calls"), snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const call = change.doc.data();
                    if (call.target === currentUser.email && call.status === "ringing") {
                        currentCallId = change.doc.id;
                        document.getElementById('caller-name-label').innerText = call.callerName + " h√≠v t√©ged...";
                        document.getElementById('incoming-call-box').style.display = "flex";
                    }
                }
            });
        });
    }

    function openFriendChat(email, name) {
        selectedFriendEmail = email;
        activeChatId = [currentUser.email, email].sort().join("_");
        document.getElementById('chat-title').innerText = name;
        document.getElementById('call-tools').style.display = "flex";
        
        onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc")), snap => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === currentUser.email ? 'sent' : 'received'}`;
                div.innerHTML = `<div>${m.text}</div>`;
                div.onclick = () => { if(m.sender === currentUser.email && confirm("T√∂rl√∂d?")) deleteDoc(doc(db, "chats", activeChatId, "messages", d.id)); };
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMessage = async () => {
        const val = document.getElementById('msg-input').value;
        if(!val || !activeChatId) return;
        document.getElementById('msg-input').value = "";
        await addDoc(collection(db, "chats", activeChatId, "messages"), { text: val, sender: currentUser.email, senderName: currentUser.displayName, time: Date.now() });
    };

    // --- H√çV√ÅS LOGIKA (FIXED) ---
    window.initCall = async (video) => {
        const callDoc = doc(collection(db, "calls"));
        currentCallId = callDoc.id;

        localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('call-screen').style.display = "flex";

        pc = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const remoteStream = new MediaStream();
        document.getElementById('remote-video').srcObject = remoteStream;
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        await setDoc(callDoc, { 
            caller: currentUser.email, callerName: currentUser.displayName, 
            target: selectedFriendEmail, status: "ringing", 
            offer: { type: offer.type, sdp: offer.sdp } 
        });

        onSnapshot(callDoc, s => {
            const data = s.data();
            if(data?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            if(data?.status === "ended") closeCallUI();
        });

        pc.onicecandidate = e => e.candidate && addDoc(collection(db, "calls", currentCallId, "callerCandidates"), e.candidate.toJSON());
        onSnapshot(collection(db, "calls", currentCallId, "targetCandidates"), s => s.docChanges().forEach(c => c.type === "added" && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
    };

    window.answerCall = async () => {
        document.getElementById('incoming-call-box').style.display = "none";
        document.getElementById('call-screen').style.display = "flex";

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-video').srcObject = localStream;

        const callDoc = doc(db, "calls", currentCallId);
        const callData = (await getDoc(callDoc)).data();

        pc = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const remoteStream = new MediaStream();
        document.getElementById('remote-video').srcObject = remoteStream;
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

        await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp }, status: "active" });

        pc.onicecandidate = e => e.candidate && addDoc(collection(db, "calls", currentCallId, "targetCandidates"), e.candidate.toJSON());
        onSnapshot(collection(db, "calls", currentCallId, "callerCandidates"), s => s.docChanges().forEach(c => c.type === "added" && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
        onSnapshot(callDoc, s => s.data()?.status === "ended" && closeCallUI());
    };

    window.endCall = async () => {
        if(currentCallId) await updateDoc(doc(db, "calls", currentCallId), { status: "ended" });
        closeCallUI();
    };

    function closeCallUI() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(pc) pc.close();
        document.getElementById('call-screen').style.display = "none";
        document.getElementById('incoming-call-box').style.display = "none";
    }

    window.toggleCam = () => {
        const t = localStream.getVideoTracks()[0];
        t.enabled = !t.enabled;
        document.getElementById('cam-btn').innerText = t.enabled ? "üìπ" : "üö´";
    };

    window.toggleMic = () => {
        const t = localStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
        document.getElementById('mic-btn').innerText = t.enabled ? "üéôÔ∏è" : "üîá";
    };

    // Alap funkci√≥k
    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert(e.message));
    window.register = async () => {
        const res = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
        await updateProfile(res.user, { displayName: document.getElementById('reg-name').value });
        await setDoc(doc(db, "users", res.user.email), { name: document.getElementById('reg-name').value, friends: [], photoURL: "" });
        location.reload();
    };
    window.logout = () => signOut(auth);
    window.addFriend = async () => {
        const e = prompt("Bar√°t email c√≠me:");
        if(e) await updateDoc(doc(db, "users", currentUser.email), { friends: arrayUnion({ email: e, name: e.split('@')[0] }) });
    };
    document.getElementById('p-upload').onchange = e => {
        const reader = new FileReader(); reader.readAsDataURL(e.target.files[0]);
        reader.onload = async () => await updateDoc(doc(db, "users", currentUser.email), { photoURL: reader.result });
    };

</script>
</body>
</html>
